# ========================================
# ğŸ® Game Tracker - Development Makefile - Generated by IA
# ========================================

.PHONY: help dev build clean install lint test commit push reset info
.DEFAULT_GOAL := help

# Colors for output
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RED := \033[31m
RESET := \033[0m

# Variables
PNPM := pnpm
NPX := npx
NODE := node

# Detect OS for cross-platform commands
ifeq ($(OS),Windows_NT)
    RM_RF = rmdir /s /q
    FIND_DELETE = del /s /q
    NULL_DEVICE = nul
else
    RM_RF = rm -rf
    FIND_DELETE = find . -name
    NULL_DEVICE = /dev/null
endif

# ========================================
# ğŸ“– Help & Info
# ========================================

help: ## ğŸ“– Show this help message
	@echo "$(BLUE)ğŸ® Game Tracker - Available Commands:$(RESET)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
	awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(RESET) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)ğŸ“ Usage: make <command>$(RESET)"

info: ## ğŸ“Š Show project information
	@echo "$(BLUE)ğŸ“– Project Information:$(RESET)"
	@echo "Node: $$($(NODE) --version)"
	@echo "pnpm: $$($(PNPM) --version)"
	@echo "Git: $$(git --version)"
	@echo ""
	@echo "$(BLUE)ğŸ“Š Project Structure:$(RESET)"
	@find packages -name "*.ts" -o -name "*.tsx" | wc -l | xargs echo "TypeScript files:"
	@find packages -name "*.js" -o -name "*.jsx" | wc -l | xargs echo "JavaScript files:"

# ========================================
# ğŸ“¥ Installation & Setup
# ========================================

install: ## ğŸ“¥ Install all dependencies
	@echo "$(YELLOW)ğŸ“¥ Installing dependencies...$(RESET)"
	$(PNPM) install
	@echo "$(GREEN)âœ… Dependencies installed$(RESET)"

setup: install build-shared ## ğŸ”§ Initial project setup
	@echo "$(GREEN)âœ… Project setup completed$(RESET)"

# ========================================
# ğŸ—ï¸ Build Commands
# ========================================

build-shared: ## ğŸ“¦ Build shared package
	@echo "$(YELLOW)ğŸ“¦ Building shared package...$(RESET)"
	$(PNPM) run build:shared
	@echo "$(GREEN)âœ… Shared package built$(RESET)"

build-backend: build-shared ## ğŸ”§ Build backend
	@echo "$(YELLOW)ğŸ”§ Building backend...$(RESET)"
	$(PNPM) --filter backend build
	@echo "$(GREEN)âœ… Backend built$(RESET)"

build-frontend: ## ğŸ¨ Build frontend
	@echo "$(YELLOW)ğŸ¨ Building frontend...$(RESET)"
	$(PNPM) --filter frontend build
	@echo "$(GREEN)âœ… Frontend built$(RESET)"

build: build-shared build-backend build-frontend ## ğŸ“¦ Build all packages
	@echo "$(GREEN)âœ… All packages built successfully$(RESET)"

# ========================================
# ğŸš€ Development Commands
# ========================================

dev: build-shared ## ğŸš€ Start full development environment
	@echo "$(YELLOW)ğŸš€ Starting development environment...$(RESET)"
	$(PNPM) run dev

dev-backend: build-shared ## ğŸ”§ Start backend development only
	@echo "$(YELLOW)ğŸ”§ Starting backend development...$(RESET)"
	$(PNPM) run dev:backend

dev-frontend: ## ğŸ¨ Start frontend development only
	@echo "$(YELLOW)ğŸ¨ Starting frontend development...$(RESET)"
	$(PNPM) run dev:frontend

dev-shared: ## ğŸ“¦ Start shared package in watch mode
	@echo "$(YELLOW)ğŸ“¦ Starting shared in watch mode...$(RESET)"
	$(PNPM) run dev:shared

# ========================================
# ğŸ§¹ Cleaning Commands
# ========================================

clean: ## ğŸ§¹ Clean build artifacts
	@echo "$(YELLOW)ğŸ§¹ Cleaning build artifacts...$(RESET)"
ifeq ($(OS),Windows_NT)
	@if exist "packages\backend\dist" $(RM_RF) "packages\backend\dist" 2>$(NULL_DEVICE) || echo.
	@if exist "packages\frontend\build" $(RM_RF) "packages\frontend\build" 2>$(NULL_DEVICE) || echo.
	@if exist "packages\frontend\.next" $(RM_RF) "packages\frontend\.next" 2>$(NULL_DEVICE) || echo.
	@if exist "packages\shared\dist" $(RM_RF) "packages\shared\dist" 2>$(NULL_DEVICE) || echo.
else
	@find packages -name "dist" -type d -exec rm -rf {} + 2>$(NULL_DEVICE) || true
	@find packages -name "build" -type d -exec rm -rf {} + 2>$(NULL_DEVICE) || true
	@find packages -name ".next" -type d -exec rm -rf {} + 2>$(NULL_DEVICE) || true
endif
	@echo "$(GREEN)âœ… Build artifacts cleaned$(RESET)"

clean-deps: ## ğŸ§¹ Clean node_modules
	@echo "$(YELLOW)ğŸ§¹ Cleaning node_modules...$(RESET)"
ifeq ($(OS),Windows_NT)
	@if exist "node_modules" $(RM_RF) "node_modules" 2>$(NULL_DEVICE) || echo.
	@if exist "packages\backend\node_modules" $(RM_RF) "packages\backend\node_modules" 2>$(NULL_DEVICE) || echo.
	@if exist "packages\frontend\node_modules" $(RM_RF) "packages\frontend\node_modules" 2>$(NULL_DEVICE) || echo.
	@if exist "packages\shared\node_modules" $(RM_RF) "packages\shared\node_modules" 2>$(NULL_DEVICE) || echo.
else
	@$(RM_RF) node_modules packages/*/node_modules 2>$(NULL_DEVICE) || true
endif
	@echo "$(GREEN)âœ… Dependencies cleaned$(RESET)"

clean-cache: ## ğŸ§¹ Clean pnpm cache
	@echo "$(YELLOW)ğŸ§¹ Cleaning cache...$(RESET)"
	$(PNPM) store prune
	@$(RM_RF) .pnpm-cache 2>$(NULL_DEVICE) || true
	@echo "$(GREEN)âœ… Cache cleaned$(RESET)"

clean-all: clean clean-deps clean-cache ## ğŸ§¹ Deep clean everything
	@echo "$(GREEN)âœ… Everything cleaned$(RESET)"

# ========================================
# ğŸ” Code Quality
# ========================================

lint: ## ğŸ” Run ESLint on all packages
	@echo "$(YELLOW)ğŸ” Running ESLint...$(RESET)"
	$(PNPM) run lint
	@echo "$(GREEN)âœ… Linting completed$(RESET)"

lint-fix: ## ğŸ”§ Fix ESLint issues
	@echo "$(YELLOW)ğŸ”§ Fixing ESLint issues...$(RESET)"
	$(PNPM) run lint:fix
	@echo "$(GREEN)âœ… ESLint issues fixed$(RESET)"

format: ## ğŸ’„ Format code with Prettier
	@echo "$(YELLOW)ğŸ’„ Formatting code...$(RESET)"
	$(NPX) prettier --write "packages/**/*.{ts,tsx,js,jsx,json,md}"
	@echo "$(GREEN)âœ… Code formatted$(RESET)"

typecheck: ## ğŸ“Š Run TypeScript type checking
	@echo "$(YELLOW)ğŸ“Š Type checking...$(RESET)"
	$(PNPM) --filter shared run build --noEmit || true
	$(PNPM) --filter backend run build --noEmit || true
	$(PNPM) --filter frontend run build --noEmit || true
	@echo "$(GREEN)âœ… Type checking completed$(RESET)"

# ========================================
# ğŸ§ª Testing
# ========================================

test: ## ğŸ§ª Run all tests
	@echo "$(YELLOW)ğŸ§ª Running tests...$(RESET)"
	$(PNPM) run test
	@echo "$(GREEN)âœ… Tests completed$(RESET)"

test-backend: ## ğŸ§ª Run backend tests only
	@echo "$(YELLOW)ğŸ§ª Running backend tests...$(RESET)"
	$(PNPM) --filter backend test
	@echo "$(GREEN)âœ… Backend tests completed$(RESET)"

test-frontend: ## ğŸ§ª Run frontend tests only
	@echo "$(YELLOW)ğŸ§ª Running frontend tests...$(RESET)"
	$(PNPM) --filter frontend test
	@echo "$(GREEN)âœ… Frontend tests completed$(RESET)"

test-watch: ## ğŸ§ª Run tests in watch mode
	@echo "$(YELLOW)ğŸ§ª Running tests in watch mode...$(RESET)"
	$(PNPM) run test --watch

# ========================================
# ğŸš€ Git & Deployment
# ========================================

commit: ## âœ¨ Create commit with gitmoji
	@echo "$(YELLOW)âœ¨ Opening gitmoji commit...$(RESET)"
	$(PNPM) run commit

push: lint test ## ğŸš€ Push to remote (with checks)
	@echo "$(YELLOW)ğŸš€ Running pre-push checks...$(RESET)"
	@echo "$(GREEN)âœ… All checks passed, pushing...$(RESET)"
	git push

# ========================================
# ğŸ”„ Reset & Maintenance
# ========================================

reset: clean-all install build ## ğŸ”„ Complete reset of development environment
	@echo "$(GREEN)âœ… Development environment reset completed$(RESET)"

fresh: reset ## ğŸ”„ Alias for reset
	@echo "$(GREEN)âœ… Fresh installation completed$(RESET)"

# ========================================
# ğŸ¯ Productivity Aliases
# ========================================

d: dev ## ğŸš€ Quick alias for dev
b: build ## ğŸ“¦ Quick alias for build
c: clean ## ğŸ§¹ Quick alias for clean
l: lint ## ğŸ” Quick alias for lint
t: test ## ğŸ§ª Quick alias for test
i: install ## ğŸ“¥ Quick alias for install

# ========================================
# ğŸš€ CI/CD Pipeline
# ========================================

ci: lint typecheck test build ## ğŸ¤– Run full CI pipeline
	@echo "$(GREEN)âœ… CI pipeline completed successfully$(RESET)"

# ========================================
# ğŸ”§ Troubleshooting
# ========================================

doctor: ## ğŸ©º Diagnose common issues
	@echo "$(BLUE)ğŸ©º Running diagnostics...$(RESET)"
	@echo "Node version: $$($(NODE) --version)"
	@echo "pnpm version: $$($(PNPM) --version)"
	@echo "Git version: $$(git --version)"
	@echo ""
	@echo "Checking project structure..."
	@test -f "packages/shared/package.json" && echo "âœ… Shared package exists" || echo "âŒ Shared package missing"
	@test -f "packages/backend/package.json" && echo "âœ… Backend package exists" || echo "âŒ Backend package missing"
	@test -f "packages/frontend/package.json" && echo "âœ… Frontend package exists" || echo "âŒ Frontend package missing"
	@echo ""
	@echo "Checking dependencies..."
	@test -d "node_modules" && echo "âœ… Root dependencies installed" || echo "âŒ Run 'make install'"